# Copilot Instructions - Diary App

## Architecture Overview

This is an **Expo Router** React Native app with SQLite database using **Drizzle ORM**. The app follows an **offline-first** architecture with planned cloud sync capabilities.

### Key Stack
- **Expo Router**: File-based routing with grouped routes `(auth)` and `(tabs)`
- **Drizzle ORM + SQLite**: Database layer with schema-first approach
- **Zustand**: State management (auth, entries, settings)
- **NativeWind**: Tailwind CSS for React Native styling
- **TypeScript**: Strict typing throughout

## Critical Patterns

### 1. Database & Migrations
- **Schema**: `db/schema.ts` defines all tables using Drizzle SQLite syntax
- **Connection**: `db/connection.ts` creates the Drizzle instance
- **Migrations**: Auto-run in `app/_layout.tsx` using `useMigrations` hook
- **Generate migrations**: `npm run db:generate` when schema changes

```typescript
// All tables use text primary keys with composite IDs
id: text('id').primaryKey(),
// Dates stored as ISO strings
createdAt: text('created_at').notNull(),
```

### 2. State Management Pattern
- **Zustand stores** in `store/` directory follow specific patterns:
- Database operations wrapped in try/catch with error logging
- Loading states managed consistently
- Store methods are async and update local state after DB operations

```typescript
// Typical store pattern
const useEntriesStore = create<EntriesState>((set, get) => ({
  entries: [],
  isLoading: false,
  createEntry: async (entryData) => {
    const entry = { ...entryData, id: generateId(), timestamps };
    await database.createEntry(entry);
    await get().loadEntries(); // Reload from DB
  }
}));
```

### 3. Expo Router Structure
- `app/_layout.tsx`: Root layout with migration initialization
- `app/(tabs)/`: Main tab navigation (home, calendar, search, mood, timeline, settings)
- `app/entry/[id].tsx` & `app/entry/new.tsx`: Dynamic entry routes

### 4. Service Layer
- `services/index.ts`: Central database service with CRUD operations
- All DB operations go through this service layer, not directly from stores
- Service methods handle ID generation, timestamps, and error handling

### 5. Type Safety
- `types/index.ts`: Central type definitions
- Database schema types auto-generated by Drizzle
- All stores and components strictly typed
- No `any` types allowed

## Development Workflow

### Database Changes
1. Modify `db/schema.ts`
2. Run `npm run db:generate` to create migration
3. Restart app to run migrations automatically

### Adding New Features
1. Define types in `types/index.ts`
2. Add database schema if needed
3. Create/update service methods in `services/`
4. Add Zustand store methods if stateful
5. Create components in `components/` (reusable) or screens in `app/`

### Styling Conventions
- Use **NativeWind** classes: `className="bg-blue-500 text-white p-4"`
- Global styles in `app/global.css`
- Tailwind config in `tailwind.config.js`

## Key Dependencies

- `expo-sqlite` + `drizzle-orm`: Database layer
- `expo-router`: Navigation
- `zustand`: State management
- `nativewind`: Styling
- `react-native-calendars`: Calendar component
- `expo-image-picker`, `expo-document-picker`: Media handling
- `expo-notifications`: Reminders system

## Common Commands

```bash
npm start                 # Start development server
npm run ios/android      # Platform-specific builds  
npm run db:generate      # Generate DB migrations
npm run lint             # ESLint + Prettier check
npm run format           # Auto-fix formatting
```

## Anti-Patterns to Avoid

- Don't bypass the service layer for direct DB access
- Don't use `expo-sqlite` directly outside `db/connection.ts`
- Don't modify state without updating the database
- Don't use inline styles - use NativeWind classes
- Don't create new stores for simple local state - use React state